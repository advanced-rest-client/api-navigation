<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    <title>api-navigation test</title>
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="../api-navigation.html">
    <link rel="import" href="../../arc-polyfills/arc-polyfills.html">
    <script src="amf-loader.js"></script>
  </head>
  <body>

    <test-fixture id="Basic">
      <template>
        <api-navigation></api-navigation>
      </template>
    </test-fixture>

    <test-fixture id="Summary">
      <template>
        <api-navigation summary></api-navigation>
      </template>
    </test-fixture>

    <test-fixture id="Preselected">
      <template>
        <api-navigation summary selected="test1"></api-navigation>
      </template>
    </test-fixture>

    <script>
      suite('api-navigation', () => {
        suite('Super basics - without model', () => {
          let element;

          suiteSetup((done) => {
            element = fixture('Basic');
            flush(() => done());
          });

          test('summary is not rendered', () => {
            const panel = element.shadowRoot.querySelector('.summary');
            assert.notOk(panel);
          });

          test('documentation is not rendered', () => {
            const panel = element.shadowRoot.querySelector('.documentation');
            assert.notOk(panel);
          });

          test('types is not rendered', () => {
            const panel = element.shadowRoot.querySelector('.types');
            assert.notOk(panel);
          });

          test('security is not rendered', () => {
            const panel = element.shadowRoot.querySelector('.security');
            assert.notOk(panel);
          });

          test('endpoints is not rendered', () => {
            const panel = element.shadowRoot.querySelector('.endpoints');
            assert.notOk(panel);
          });
        });

        suite('Summary', () => {
          let element;
          setup((done) => {
            element = fixture('Summary');
            flush(() => done());
          });

          test('Summary is rendered', () => {
            const panel = element.shadowRoot.querySelector('.summary');
            assert.ok(panel);
          });

          test('Clicking on summary changes selection', () => {
            const node = element.shadowRoot.querySelector('.list-item.summary');
            node.click();
            assert.equal(element.selected, 'summary');
            assert.equal(element.selectedType, 'summary');
          });
        });

        suite('Docs', () => {
          let element;
          let model;
          setup((done) => {
            model = [{
              id: 'test1',
              label: 'test1'
            }, {
              id: 'test2',
              label: 'test2'
            }];
            element = fixture('Preselected');
            element._setDocs(model);
            flush(() => done());
          });

          test('hasDocs is computed', () => {
            assert.isTrue(element.hasDocs);
          });

          test('Docs is rendered', () => {
            const panel = element.shadowRoot.querySelector('.documentation');
            assert.ok(panel);
          });

          test('Preselected has a selection', () => {
            const selector = '.documentation [data-api-id="test1"]';
            const panel = element.shadowRoot.querySelector(selector);
            assert.ok(panel);
          });

          test('Clicking on an item changes selection', () => {
            const node = element.shadowRoot.querySelectorAll('.documentation .list-item')[1];
            node.click();
            assert.equal(element.selected, 'test2');
            assert.equal(element.selectedType, 'documentation');
          });
        });

        suite('Types', () => {
          let element;
          let model;
          setup((done) => {
            model = [{
              id: 'test1',
              label: 'test1'
            }, {
              id: 'test2',
              label: 'test2'
            }];
            element = fixture('Preselected');
            element._setTypes(model);
            flush(() => done());
          });

          test('hasTypes is computed', () => {
            assert.isTrue(element.hasTypes);
          });

          test('Types panel is rendered', () => {
            const panel = element.shadowRoot.querySelector('section.types');
            assert.ok(panel);
          });

          test('Preselected has a selection', () => {
            const selector = '.types [data-api-id="test1"]';
            const panel = element.shadowRoot.querySelector(selector);
            assert.ok(panel);
          });

          test('Clicking on an item changes selection', () => {
            const node = element.shadowRoot.querySelectorAll('.types .list-item')[1];
            node.click();
            assert.equal(element.selected, 'test2');
            assert.equal(element.selectedType, 'type');
          });
        });

        suite('Security', () => {
          let element;
          let model;
          setup((done) => {
            model = [{
              id: 'test1',
              label: 'test1'
            }, {
              id: 'test2',
              label: 'test2'
            }];
            element = fixture('Preselected');
            element._setSecurity(model);
            flush(() => done());
          });

          test('hasSecurity is computed', () => {
            assert.isTrue(element.hasSecurity);
          });

          test('Types panel is rendered', () => {
            const panel = element.shadowRoot.querySelector('section.security');
            assert.ok(panel);
          });

          test('Preselected has a selection', () => {
            const selector = '.security [data-api-id="test1"]';
            const panel = element.shadowRoot.querySelector(selector);
            assert.ok(panel);
          });

          test('Clicking on an item changes selection', () => {
            const node = element.shadowRoot.querySelectorAll('.security .list-item')[1];
            node.click();
            assert.equal(element.selected, 'test2');
            assert.equal(element.selectedType, 'security');
          });
        });

        suite('Endpoints', () => {
          let element;
          let model;
          setup((done) => {
            model = [{
              id: 'test1',
              label: 'test1',
              methods: [{
                id: 'method1',
                method: 'GET'
              }]
            }, {
              id: 'test2',
              label: 'test2',
              methods: [{
                id: 'method2',
                method: 'GET'
              }, {
                id: 'method3',
                method: 'POST'
              }]
            }];
            element = fixture('Preselected');
            element._setEndpoints(model);
            flush(() => done());
          });

          test('hasEndpoints is computed', () => {
            assert.isTrue(element.hasEndpoints);
          });

          test('Types panel is rendered', () => {
            const panel = element.shadowRoot.querySelector('section.endpoints');
            assert.ok(panel);
          });

          test('Preselected has a selection', () => {
            const selector = '.endpoints [data-api-id="test1"]';
            const panel = element.shadowRoot.querySelector(selector);
            assert.ok(panel);
          });

          test('Clicking on an item changes selection', () => {
            const node = element.shadowRoot.querySelectorAll('.endpoints .list-item.endpoint')[1];
            node.click();
            assert.equal(element.selected, 'test2');
            assert.equal(element.selectedType, 'endpoint');
          });
        });


        suite('Navigation events`', () => {
          let element;
          let model;
          setup((done) => {
            model = {
              docs: [{
                id: 'test1',
                label: 'test1'
              }, {
                id: 'test2',
                label: 'test2'
              }],
              types: [{
                id: 'test3',
                label: 'test3'
              }, {
                id: 'test4',
                label: 'test4'
              }],
              security: [{
                id: 'test5',
                label: 'test5'
              }, {
                id: 'test6',
                label: 'test6'
              }],
              endpoints: [{
                id: 'test7',
                label: 'test7',
                methods: [{
                  id: 'method8',
                  method: 'GET'
                }]
              }, {
                id: 'test9',
                label: 'test9',
                methods: [{
                  id: 'method10',
                  method: 'GET'
                }, {
                  id: 'method11',
                  method: 'POST'
                }]
              }]
            };
            element = fixture('Basic');
            element._setDocs(model.doce);
            element._setTypes(model.types);
            element._setSecurity(model.security);
            element._setEndpoints(model.endpoints);
            flush(() => done());
          });

          function fire(id, type, node) {
            const e = new CustomEvent('api-navigation-selection-changed', {
              bubbles: true,
              composed: true,
              detail: {
                selected: id,
                type: type
              }
            });
            (node || document.body).dispatchEvent(e);
          }

          test('Updates selection from the change event', () => {
            const id = 'test3';
            fire(id, 'type');
            assert.equal(element.selected, id);
            assert.equal(element.selectedType, 'type');
            const node = element.shadowRoot.querySelector(`[data-api-id="${id}"]`);
            assert.isTrue(node.classList.contains('iron-selected'));
          });

          test('Does not update selection if it is the source', () => {
            const id = 'test3';
            fire(id, 'type', element);
            assert.isUndefined(element.selected);
          });

          test('Does not dispatch selection event', () => {
            const id = 'test3';
            const spy = sinon.spy();
            element.addEventListener('api-navigation-selection-changed', spy);
            fire(id, 'type');
            assert.isFalse(spy.called);
          });
        });
      });
      /* global AmfLoader */
      suite('AMF Computations', () => {
        let element;
        suiteSetup(() => {
          return AmfLoader.load()
          .then((model) => {
            element = fixture('Basic');
            element.amfModel = model;
          });
        });

        test('Collects documentaion information', () => {
          const result = element.docs;
          assert.isAbove(result.length, 0);
          assert.typeOf(result[0].id, 'string');
          assert.typeOf(result[0].label, 'string');
        });

        test('Collects types information', () => {
          const result = element.types;
          assert.isAbove(result.length, 0);
          assert.typeOf(result[0].id, 'string');
          assert.typeOf(result[0].label, 'string');
        });

        test('Collects security information', () => {
          const result = element.security;
          assert.isAbove(result.length, 0);
          assert.typeOf(result[0].id, 'string');
          assert.typeOf(result[0].label, 'string');
        });

        test('Collects endpoints information', () => {
          const result = element.endpoints;
          assert.isAbove(result.length, 0);
          assert.typeOf(result[0].id, 'string');
          assert.typeOf(result[0].label, 'string');
          assert.typeOf(result[0].methods, 'array');
        });

        test('Collects methods information', () => {
          const result = element.endpoints;
          const methods = result[0].methods;
          assert.isAbove(methods.length, 0);
          assert.typeOf(methods[0].id, 'string');
          assert.typeOf(methods[0].label, 'string');
          assert.typeOf(methods[0].method, 'string');
        });
      });

      suite('Passive selection', () => {
        let element;
        let amf;
        suiteSetup(() => {
          return AmfLoader.load()
          .then((model) => amf = model);
        });

        setup((done) => {
          element = fixture('Basic');
          element.amfModel = amf;
          flush(() => done());
        });

        function dispatch(selected, type) {
          const e = new CustomEvent('api-navigation-selection-changed', {
            bubbles: true,
            composed: true,
            detail: {
              selected,
              type,
              passive: true
            }
          });
          this.dispatchEvent(e);
        }

        test('Selectes a method', () => {
          dispatch('file://demo/api.raml#/web-api/end-points/%2Ffiles%2F%7BfileId%7D%2Fcopy/post', 'method');
          const node = element.shadowRoot.querySelector('.passive-selected');
          assert.ok(node);
        });

        test('Opens iron-collapse', () => {
          dispatch('file://demo/api.raml#/web-api/end-points/%2Ffiles%2F%7BfileId%7D%2Fcopy/post', 'method');
          const id = 'file://demo/api.raml#/web-api/end-points/%2Ffiles%2F%7BfileId%7D%2Fcopy';
          const node = element.shadowRoot.querySelector(`.endpoint[data-api-id="${id}"]`);
          assert.isTrue(node.nextElementSibling.opened);
        });
      });

      a11ySuite('Basic');
    </script>

  </body>
</html>
